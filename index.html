<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SimplyDoors - Installation Estimator</title>
    <style>
        /* --- BRAND COLORS & BASE STYLES --- */
        :root {
            --brand-green: #7cc243;
            --brand-green-hover: #68a536;
            --brand-dark: #1d2b1d;
            --brand-light: #f6fbf2;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            color: #333;
            padding: 10px;
            margin: 0;
            font-size: 16px;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        /* --- SCREEN CALCULATOR INTERFACE --- */
        .app-header {
            text-align: center;
            border-bottom: 2px solid var(--brand-green);
            padding-bottom: 15px;
            margin-bottom: 20px;
        }
        .app-header-title {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 5px;
        }
        h1 {
            color: var(--brand-dark);
            margin: 0;
            font-size: 2.2em;
            letter-spacing: -0.5px;
            font-weight: 800;
        }
        .header-subtext {
            color: #666;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-weight: 600;
        }

        .customer-info {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        .info-group { flex: 1; min-width: 200px; }
        .info-group label { display: block; font-weight: bold; font-size: 0.85em; color: #555; margin-bottom: 6px; text-transform: uppercase; }
        .info-group input { width: 100%; padding: 12px 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; box-sizing: border-box; transition: border-color 0.2s; }
        .info-group input:focus { border-color: var(--brand-green); outline: none; }
        
        table { width: 100%; border-collapse: collapse; font-size: 15px; margin-top: 10px; }
        th, td { border: 1px solid #dee2e6; padding: 15px 10px; text-align: left; vertical-align: middle; }
        th { background-color: #e9ecef; font-weight: 600; color: #333; }

        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] {
            -moz-appearance: textfield; width: 50px; height: 44px; border: 2px solid #ccc;
            border-left: none; border-right: none; border-radius: 0; text-align: center;
            font-size: 18px; font-weight: bold; padding: 0; margin: 0; background: #fff; color: #333;
        }
        input[type="number"]:focus { outline: none; background: var(--brand-light); }

        .qty-control { display: inline-flex; align-items: center; vertical-align: middle; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-radius: 6px; }
        .qty-btn {
            width: 44px; height: 48px; background-color: var(--brand-green); color: white; border: none;
            font-size: 24px; font-weight: bold; cursor: pointer; display: flex; align-items: center;
            justify-content: center; user-select: none; transition: background-color 0.1s;
        }
        .qty-btn:active { background-color: var(--brand-green-hover); }
        .qty-btn-minus { border-radius: 6px 0 0 6px; }
        .qty-btn-plus { border-radius: 0 6px 6px 0; }

        .price-calc { display: inline-block; color: #555; white-space: nowrap; vertical-align: middle; margin-left: 12px; font-size: 0.95em; }
        .price-calc b { color: var(--brand-dark); display: inline-block; min-width: 50px; font-size: 1.1em; }

        .toggle-label {
            display: inline-flex; align-items: center; background: #fff; padding: 12px 20px;
            border-radius: 8px; cursor: pointer; margin-top: 0; border: 2px solid #ccc; user-select: none; font-size: 1.05em; transition: all 0.2s;
        }
        .toggle-label input[type="checkbox"] { width: 24px; height: 24px; margin-right: 12px; cursor: pointer; accent-color: var(--brand-green); }
        .toggle-label:has(input:checked) { background: var(--brand-light); border-color: var(--brand-green); }

        .row-total { font-weight: bold; background-color: #f8f9fa; font-size: 1.15em; text-align: right; color: var(--brand-dark); }

        .grand-total-container {
            margin-top: 25px; text-align: center; font-size: 2em; font-weight: bold;
            background-color: var(--brand-light); padding: 25px; border-radius: 8px; border: 2px solid var(--brand-green); color: var(--brand-dark);
        }
        
        .multiplier-row { background-color: #fffdf0; }
        .toggle-row { background-color: #f8f9fa; }
        .auto-row { background-color: #f8f9fa; }
        .caulk-summary-row td { padding: 15px; font-size: 1em; border-top: 2px dashed #ccc; }
        
        .mobile-label { display: none; }
        
        .multiplier-controls { display: flex; align-items: center; justify-content: center; gap: 15px; flex-wrap: wrap; }
        .percent-input-wrapper { display: flex; align-items: center; background: #fff; padding: 6px 12px; border-radius: 8px; border: 2px solid #ccc; font-weight: bold; }
        .percent-input-wrapper input { width: 55px; height: 34px; border: 1px solid #ccc; border-radius: 4px; text-align: center; font-size: 18px; margin-right: 5px; font-weight: bold;}
        .percent-input-wrapper input:focus { border-color: var(--brand-green); outline: none; background: var(--brand-light); }

        .action-buttons { display: flex; gap: 15px; margin-top: 25px; }
        .btn {
            flex: 1; padding: 16px; font-size: 1.2em; font-weight: bold; text-align: center;
            border: none; border-radius: 8px; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.1); color: white; transition: transform 0.1s, box-shadow 0.1s;
        }
        .btn:active { transform: translateY(2px); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .btn-print { background-color: var(--brand-green); color: var(--brand-dark); font-weight: 800; }
        .btn-reset { background-color: #dc3545; }

        /* --- STRICT 2-PAGE BRANDED PRINT PROPOSAL LAYOUT --- */
        #printProposal { display: none; }
        
        @media print {
            @page { margin: 0.35in; size: letter portrait; }
            
            body { 
                background-color: white; 
                padding: 0; 
                color: #000; 
                -webkit-print-color-adjust: exact !important; 
                print-color-adjust: exact !important; 
            }
            .container { box-shadow: none; max-width: 100%; padding: 0; margin: 0; }
            
            /* Hide UI */
            .app-header, .customer-info, #estimatorTable, .grand-total-container, .action-buttons { display: none !important; }
            
            #printProposal { display: block; width: 100%; }
            
            /* ======================================= */
            /* PAGE 1: HEADER, CUSTOMER, SCOPE, TOTAL  */
            /* ======================================= */
            .prop-header { margin-bottom: 12px; border-bottom: 2px solid #7cc243; padding-bottom: 8px; }
            .prop-header-content { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 8px; }
            .brand-logo-container { display: flex; align-items: center; gap: 12px; }
            .brand-text h1 { color: #1d2b1d; margin: 0; font-size: 30px; font-weight: 800; letter-spacing: -0.5px; }
            .brand-text p { color: #1d2b1d; margin: 0; font-size: 11px; letter-spacing: 0.5px; font-weight: 600; text-transform: uppercase; }
            .company-contact { text-align: right; font-size: 10px; color: #444; line-height: 1.4; }
            .proposal-title-bar { padding-top: 4px; }
            .proposal-title-bar h2 { margin: 0; font-size: 12px; color: #555; text-transform: uppercase; letter-spacing: 2px; }
            
            .prop-meta-grid { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 11px; }
            .prop-meta-grid div { flex: 1; }
            .prop-meta-label { font-weight: bold; color: #666; font-size: 9px; text-transform: uppercase; display: block; margin-bottom: 2px; }
            .prop-meta-value { font-size: 14px; font-weight: bold; color: #111; }
            
            .prop-summary-box { background-color: #f8f9fa; border: 1px solid #7cc243; padding: 10px; border-radius: 6px; margin-bottom: 15px; text-align: center; }
            .prop-summary-box h2 { margin: 0; font-size: 16px; color: #1d2b1d; }
            
            /* Tightly Packed Scope Section to guarantee fitting on Page 1 */
            .prop-scope-section { margin-bottom: 10px; }
            .prop-scope-section h3 { border-bottom: 1px solid #ccc; padding-bottom: 3px; margin-bottom: 8px; color: #333; font-size: 13px; text-transform: uppercase; }
            
            /* Bulletproof Inline-Block 2-Column Grid */
            #printScopeList { display: block; width: 100%; font-size: 0; }
            .print-scope-item { 
                display: inline-block; vertical-align: top; width: 48%; margin-right: 4%; 
                box-sizing: border-box; page-break-inside: avoid; break-inside: avoid;
                margin-bottom: 10px; padding-left: 8px; border-left: 3px solid #7cc243; font-size: 11px; 
            }
            .print-scope-item:nth-child(even) { margin-right: 0; }
            
            .print-scope-item h4 { margin: 0 0 2px 0; font-size: 11.5px; color: #000; font-weight: bold; }
            .print-scope-item p { margin: 0; font-size: 10px; color: #444; line-height: 1.25; }
            
            /* Total Section pinned to bottom of Page 1 */
            .prop-total-section { text-align: right; margin-bottom: 0; border-top: 1px solid #eee; padding-top: 10px; page-break-inside: avoid; }
            .prop-total-label { font-size: 12px; color: #666; text-transform: uppercase; letter-spacing: 1px; font-weight: bold; }
            .prop-total-value { font-size: 28px; font-weight: bold; color: #1d2b1d; display: inline-block; margin-top: 0px; min-width: 150px; }
            
            /* ======================================= */
            /* PAGE 2: LEGAL TERMS & SIGNATURE         */
            /* ======================================= */
            .prop-terms-section { 
                page-break-before: always; /* FORCES PAGE 2 */
                break-before: page;
                margin-top: 0; 
                padding-top: 0; 
                border-top: none; 
            }
            .prop-terms-section h3 { margin: 0 0 5px 0; font-size: 16px; color: #1d2b1d; text-transform: uppercase; border-bottom: 2px solid #1d2b1d; padding-bottom: 6px; }
            .terms-intro { font-size: 11px; color: #555; margin: 0 0 15px 0; font-style: italic; }
            
            /* Bulletproof Inline-Block 2-Column Grid for Terms */
            .terms-grid { display: block; width: 100%; font-size: 0; }
            .terms-col { 
                display: inline-block; vertical-align: top; width: 48%; margin-right: 4%; 
                box-sizing: border-box; font-size: 11px; 
            }
            .terms-col:last-child { margin-right: 0; }

            .terms-col h4 { margin: 0 0 6px 0; font-size: 12px; color: #7cc243; text-transform: uppercase; border-bottom: 1px solid #eee; padding-bottom: 4px; }
            .terms-col p { margin: 0 0 6px 0; font-size: 10.5px; color: #333; line-height: 1.4; }
            .terms-col ul { margin: 0 0 15px 0; padding-left: 18px; font-size: 10.5px; color: #333; line-height: 1.4; }
            .terms-col li { margin-bottom: 4px; }
            .terms-col em { font-size: 10px; color: #666; display: block; margin-bottom: 20px; font-style: italic; }

            /* Signature Box fits nicely at bottom of Page 2 */
            .prop-signature-box { border: 1px solid #ccc; padding: 20px; border-radius: 6px; margin-top: 30px; page-break-inside: avoid; background-color: #f8f9fa; }
            .prop-signature-box h4 { margin: 0 0 6px 0; font-size: 14px; text-transform: uppercase; color: #1d2b1d; }
            .prop-signature-box p { font-size: 11px; color: #555; margin: 0 0 35px 0; line-height: 1.4; }
            .sig-lines { display: flex; justify-content: space-between; }
            .sig-line { border-top: 1px solid #000; width: 45%; padding-top: 6px; font-size: 12px; color: #222; font-weight: bold; }
        }

        /* --- MOBILE SCREEN LAYOUT --- */
        @media screen and (max-width: 850px) {
            table, thead, tbody, th, td, tr { display: block; }
            thead tr { position: absolute; top: -9999px; left: -9999px; }
            tr { margin-bottom: 1.5rem; border: 2px solid #ddd; border-radius: 8px; padding: 15px; background-color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
            td { border: none; padding: 5px 0; position: relative; }
            td:nth-child(2), td:nth-child(3), td:nth-child(4) { background: #f8f9fa; margin-top: 10px; padding: 15px; border-radius: 8px; border: 1px solid #eee; text-align: center; }
            .mobile-label { display: block; font-size: 1.1em; font-weight: bold; color: #333; margin-bottom: 10px; }
            .qty-control, .toggle-label { width: 100%; justify-content: center; margin-bottom: 10px; box-sizing: border-box; }
            .qty-control input { flex-grow: 1; max-width: 100px; }
            .price-calc { display: block; margin-left: 0; font-size: 1.1em; background: #fff; padding: 8px; border-radius: 6px; border: 1px solid #e9ecef; }
            .row-total { border-top: 1px solid #ddd; margin-top: 15px; padding-top: 15px; font-size: 1.3em; background-color: transparent; }
            .row-total::before { content: "Row Subtotal: "; font-weight: normal; font-size: 0.8em; color: #666; }
            .multiplier-row td[colspan="3"], .toggle-row td[colspan="3"], .caulk-summary-row td[colspan="2"] { display: block; width: 100%; margin-top: 10px; background-color: transparent; text-align: center !important; }
            .action-buttons { flex-direction: column; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="app-header">
        <div class="app-header-title">
            <svg width="45" height="45" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <path d="M 45 20 L 85 20 L 85 80 L 45 80" fill="none" stroke="#7cc243" stroke-width="7" stroke-linecap="round" stroke-linejoin="round" />
                <polygon points="15,5 45,20 45,80 15,95" fill="#7cc243" />
                <circle cx="36" cy="50" r="3" fill="#ffffff" />
            </svg>
            <h1>SimplyDoors</h1>
        </div>
        <div class="header-subtext">Internal Estimation Tool</div>
    </div>

    <div class="customer-info">
        <div class="info-group">
            <label>Customer Name</label>
            <input type="text" id="custName" placeholder="Enter Client Name">
        </div>
        <div class="info-group">
            <label>Project Address</label>
            <input type="text" id="custAddress" placeholder="Enter Jobsite Address">
        </div>
        <div class="info-group" style="flex: 0.5;">
            <label>Date</label>
            <input type="date" id="quoteDate">
        </div>
    </div>
    
    <table id="estimatorTable">
        <thead>
            <tr>
                <th>Item</th>
                <th>Sm Qty</th>
                <th>Med Qty</th>
                <th>Lrg Qty</th>
                <th>Row Total</th>
            </tr>
        </thead>
        <tbody id="tableBody">
            </tbody>
    </table>

    <div class="grand-total-container">
        Grand Total: <br><span id="grandTotal">$0.00</span>
    </div>

    <div class="action-buttons">
        <button class="btn btn-print" onclick="triggerPrint()">Save / Print Proposal</button>
        <button class="btn btn-reset" onclick="resetCalculator()">Clear Calculator</button>
    </div>

    <div id="printProposal">
        
        <div class="prop-header">
            <div class="prop-header-content">
                <div class="brand-logo-container">
                    <svg width="60" height="60" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                        <path d="M 45 20 L 85 20 L 85 80 L 45 80" fill="none" stroke="#7cc243" stroke-width="7" stroke-linecap="round" stroke-linejoin="round" />
                        <polygon points="15,5 45,20 45,80 15,95" fill="#7cc243" />
                        <circle cx="36" cy="50" r="3" fill="#ffffff" />
                    </svg>
                    <div class="brand-text">
                        <h1>SimplyDoors</h1>
                        <p>New Doors, Made Easy</p>
                    </div>
                </div>
                <div class="company-contact">
                    <strong>17750 Lookout Rd Suite 150</strong><br>
                    Selma, TX 78154<br>
                    Phone: 210-903-8450<br>
                    sales@SimplyDoors.com<br>
                    simplydoors.com
                </div>
            </div>
            <div class="proposal-title-bar">
                <h2>Official Installation Proposal</h2>
            </div>
        </div>

        <div class="prop-meta-grid">
            <div>
                <span class="prop-meta-label">Prepared For</span>
                <span class="prop-meta-value" id="printName">________________</span>
            </div>
            <div>
                <span class="prop-meta-label">Property Address</span>
                <span class="prop-meta-value" id="printAddress">________________</span>
            </div>
            <div>
                <span class="prop-meta-label">Date</span>
                <span class="prop-meta-value" id="printDate">________________</span>
            </div>
        </div>

        <div class="prop-summary-box">
            <h2 id="printSummaryText">Proposal for the installation of 0 window(s)</h2>
        </div>

        <div class="prop-scope-section">
            <h3>Scope of Work Included</h3>
            <div id="printScopeList">
                </div>
        </div>

        <div class="prop-total-section">
            <span class="prop-total-label">Total Investment</span><br>
            <span class="prop-total-value" id="printGrandTotal">$0.00</span>
        </div>

        <div class="prop-terms-section">
            <h3>SimplyDoors Window Installation Terms & Conditions</h3>
            <p class="terms-intro">These terms supplement and govern the installation services described in this proposal.</p>
            
            <div class="terms-grid">
                <div class="terms-col">
                    <h4>1. Customer Responsibilities</h4>
                    <ul>
                        <li>Provide clear, safe access to each window opening.</li>
                        <li>Remove blinds, curtains, shutters, window coverings, furniture, décor, or personal items within 6 feet of each opening.</li>
                        <li>Ensure pets are secured and alarms/contacts are disabled before installation.</li>
                        <li>Ensure windows are on-site and accessible if sourced by Customer.</li>
                    </ul>
                    <em>*Failure to meet readiness requirements may result in additional labor charges.</em>

                    <h4>2. Hidden Conditions & Additional Work</h4>
                    <p>SimplyDoors is not responsible for concealed damage discovered during removal, including:</p>
                    <ul>
                        <li>Water intrusion, rot or mold.</li>
                        <li>Structural issues or framing inconsistencies.</li>
                        <li>Pest damage.</li>
                        <li>Electrical, plumbing, or mechanical interference.</li>
                        <li>Out-of-square or non-standard openings.</li>
                    </ul>
                    <em>*Required corrective work will be billed as a change order at: $100/hr per installer + materials.</em>
                </div>

                <div class="terms-col">
                    <h4>3. Exclusions</h4>
                    <p>Unless explicitly listed in this proposal, the following are not included:</p>
                    <ul>
                        <li>Stucco patching or texture matching.</li>
                        <li>Drywall repair or painting.</li>
                        <li>Tile/stone repair or replacement.</li>
                        <li>Interior trim repair or replacement.</li>
                        <li>Reframing or structural modifications.</li>
                        <li>Interior finish work (paint, stain, touch-ups).</li>
                        <li>Remediation of mold, rot, or pests.</li>
                        <li>Lead or asbestos abatement.</li>
                    </ul>

                    <h4>4. Warranty</h4>
                    <ul>
                        <li>Installation workmanship is warranted for 1 year from completion.</li>
                        <li>Warranty excludes: Damage caused by settling, movement, misuse, or lack of maintenance.</li>
                        <li>Caulking/sealant failure beyond 1 year is excluded (industry-standard maintenance item).</li>
                        <li>Product warranties are provided directly by the manufacturer.</li>
                    </ul>

                    <h4>5. Dispute Window</h4>
                    <p style="margin-bottom: 12px;">Customer must report installation concerns within 3 business days of completion.</p>

                    <h4>6. Limitation of Liability</h4>
                    <p>The Company’s maximum liability is limited to the cost of installation services provided. Indirect, incidental, or consequential damages are excluded.</p>
                </div>
            </div>
            
            <div class="prop-signature-box">
                <h4>Acceptance of Proposal</h4>
                <p>The Customer acknowledges that they have reviewed and accept the scope of work, agree to the Terms and Conditions attached to this proposal, and hereby authorize SimplyDoors to perform the installation services described.</p>
                <div class="sig-lines">
                    <div class="sig-line">Customer Signature</div>
                    <div class="sig-line" style="width: 30%;">Date</div>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    // Format local date string explicitly
    const today = new Date();
    const localDateStr = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0') + '-' + String(today.getDate()).padStart(2, '0');
    document.getElementById('quoteDate').value = localDateStr;

    function formatMoney(amount) {
        return amount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    const pricingData = [
        { 
            id: 5, item: "Install New Windows", pS: 90, pM: 150, pL: 200, type: "standard",
            desc: "Placement, leveling, shimming, fastening, and securing the new window unit per manufacturer guidelines and local building standards. Includes proper insulation and water-seal preparation prior to interior/exterior finishing. Components such as sill pan, flashing tape, and caulking will be installed as needed dependent on the approved installation method."
        },
        { 
            id: 1, item: "Remove Existing Windows", pS: 70, pM: 125, pL: 180, type: "standard",
            desc: "Includes the removal of the existing window sash, frame, trim, and related components as needed for the approved installation method. Does not include repair of concealed damage unless noted elsewhere."
        },
        { 
            id: 2, item: "Cutback Stucco", pS: 90, pM: 140, pL: 200, type: "standard",
            desc: "Cutting and removing stucco around the window perimeter to allow for full-frame replacement or access to structural components. Patching/reapplying stucco is not included unless otherwise specified."
        },
        { 
            id: 6, item: "Caulk Interior", pS: 10, pM: 10, pL: 20, type: "auto_item", dependsOn: 1, hidden: true,
            desc: "Application of interior-grade caulking or sealant around casing and trim to create a clean finish and reduce air leakage. Does not include painting unless specified." 
        },
        { 
            id: 7, item: "Caulk Exterior", pS: 10, pM: 10, pL: 20, type: "auto_item", dependsOn: 1, hidden: true,
            desc: "Weather-grade exterior caulking of perimeter joints to seal against water and air infiltration. Color matching provided where available. Does not include repainting of adjacent surfaces unless otherwise listed." 
        },
        { 
            id: 3, item: "Cutback Sheetrock Or Wood Returns", pS: 40, pM: 60, pL: 80, type: "standard",
            desc: "Removal or trimming of interior drywall or wood return extensions to allow the new window to fit properly within the opening. Prepares the area for reinstall or replacement of returns (return rebuild is separate unless listed)."
        },
        { 
            id: 4, item: "Cutback Tile Or Stone Returns", pS: 80, pM: 120, pL: 160, type: "standard",
            desc: "Precision cutting and removal of tile or stone at the window return area to allow installation access. This may involve specialty tools and dust management. Tile/stone repair or replacement is not included unless noted."
        },
        { 
            id: 8, item: "Apply Exterior Trim", pS: 40, pM: 60, pL: 80, type: "standard",
            desc: "Installation of new exterior trim components such as brick mold, PVC trim, or wood trim depending on the scope. Includes cutting, fastening, and prepping joints for caulk. Painting or staining is excluded unless specified."
        },
        { 
            id: 11, item: "Working In Lived In Home", type: "multiplier_input", defaultPercent: 15, range: [1, 2, 3, 4, 5, 6, 7, 8],
            desc: "Additional time and protective measures required when working in an occupied home. Includes daily cleanup, noise and dust management, and accommodating homeowner schedule constraints."
        },
        { 
            id: 10, item: "Haul Away Debris", pS: 10, pM: 15, pL: 20, type: "item_toggle", dependsOn: 5,
            desc: "Collection, loading, and disposal of construction debris generated by window removal and installation. Includes disposal of glass, wood, and packaging materials. Does not include whole-house junk removal."
        },
        { 
            id: 9, item: "Setting Up/Taking Down Scaffolding", pS: 30, pM: 30, pL: 50, type: "item_toggle", dependsOn: 5,
            desc: "Transporting, assembling, securing, and dismantling scaffolding required to access elevated window openings."
        },
        { 
            id: 12, item: "Site Access Limited", type: "multiplier_input", defaultPercent: 10, range: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10],
            desc: "Additional time required due to restricted access such as long carries, tight stairways, limited parking, uneven terrain, locked or gated areas, or inability to stage materials near the work area. Adds time to both removal and installation activities."
        }
    ];

    let quantities = {};

    function init() {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = ''; 
        
        pricingData.forEach(row => {
            quantities[row.id] = { s: 0, m: 0, l: 0, checked: false, percent: row.defaultPercent || 0 };
            if (row.hidden) return; 

            const tr = document.createElement('tr');
            let inputHtml = '';
            let itemHtml = `<strong style="font-size: 1.05em; color: var(--brand-dark);">${row.item}</strong>`;

            if (row.type === 'standard') {
                const sizes = [
                    {key: 's', label: 'Small', price: row.pS}, 
                    {key: 'm', label: 'Medium', price: row.pM}, 
                    {key: 'l', label: 'Large', price: row.pL}
                ];
                
                sizes.forEach(sz => {
                    inputHtml += `
                        <td>
                            <div class="mobile-label">${sz.label} Size</div>
                            <div class="qty-control">
                                <button type="button" class="qty-btn qty-btn-minus" onclick="adjustQty(${row.id}, '${sz.key}', -1)">−</button>
                                <input type="number" id="input-${row.id}-${sz.key}" min="0" value="0" inputmode="numeric" onfocus="this.select()" onchange="updateQty(${row.id}, '${sz.key}', this.value)">
                                <button type="button" class="qty-btn qty-btn-plus" onclick="adjustQty(${row.id}, '${sz.key}', 1)">+</button>
                            </div>
                            <span class="price-calc">@ $${sz.price} = <b id="calc-${row.id}-${sz.key}">$0.00</b></span>
                        </td>
                    `;
                });
            } else if (row.type === 'item_toggle') {
                tr.classList.add('toggle-row');
                itemHtml += `<br><small style="color: #666; font-weight: bold;">($${row.pS} / $${row.pM} / $${row.pL} per window)</small>`;
                inputHtml = `
                    <td colspan="3" style="text-align: center;">
                        <label class="toggle-label">
                            <input type="checkbox" onchange="updateToggle(${row.id}, this.checked)"> 
                            <strong>Include Service?</strong>
                        </label>
                    </td>
                `;
            } else if (row.type === 'multiplier_input') {
                tr.classList.add('multiplier-row');
                inputHtml = `
                    <td colspan="3" style="text-align: center;">
                        <div class="multiplier-controls">
                            <label class="toggle-label" style="margin-top: 0;">
                                <input type="checkbox" onchange="updateToggle(${row.id}, this.checked)">
                                <strong>Apply Surcharge</strong> 
                            </label>
                            <div class="percent-input-wrapper">
                                <input type="number" id="input-${row.id}-percent" value="${row.defaultPercent}" min="0" onfocus="this.select()" onchange="updateMultiplier(${row.id}, this.value)">
                                <span>%</span>
                            </div>
                        </div>
                    </td>
                `;
            }

            tr.innerHTML = `
                <td>${itemHtml}</td>
                ${inputHtml}
                <td class="row-total" id="total-cell-${row.id}">
                    <span id="total-${row.id}">$0.00</span>
                </td>
            `;
            tbody.appendChild(tr);
        });

        const caulkTr = document.createElement('tr');
        caulkTr.classList.add('auto-row', 'caulk-summary-row');
        caulkTr.innerHTML = `
            <td colspan="4" style="text-align: left; color: #333;">
                <strong style="font-size: 1.05em; color: var(--brand-dark);">Caulk Interior & Exterior</strong> <small style="color: #666;">(Auto-calculated from Removal count)</small>
            </td>
            <td class="row-total" id="caulkTotalSummary">$0.00</td>
        `;
        // Insert right after the Cutback Stucco
        tbody.insertBefore(caulkTr, tbody.children[3]);
        
        calculateTotals();
    }

    // Prepare print data BEFORE launching dialog
    window.addEventListener('beforeprint', preparePrint);

    function preparePrint() {
        document.getElementById('printName').innerText = document.getElementById('custName').value || '_______________________';
        document.getElementById('printAddress').innerText = document.getElementById('custAddress').value || '_______________________';
        
        const dateParts = document.getElementById('quoteDate').value.split('-');
        if(dateParts.length === 3) {
            document.getElementById('printDate').innerText = `${dateParts[1]}/${dateParts[2]}/${dateParts[0]}`;
        }

        const newWinQ = quantities[5];
        const totalWindows = newWinQ ? (newWinQ.s + newWinQ.m + newWinQ.l) : 0;
        document.getElementById('printSummaryText').innerText = `Proposal for the installation of ${totalWindows} window(s)`;

        document.getElementById('printGrandTotal').innerText = document.getElementById('grandTotal').innerText;

        const printScopeList = document.getElementById('printScopeList');
        printScopeList.innerHTML = ''; 
        
        let hasItems = false;

        pricingData.forEach(row => {
            let isSelected = false;
            
            if (row.type === 'standard' || row.type === 'auto_item') {
                const targetQ = row.type === 'auto_item' ? quantities[row.dependsOn] : quantities[row.id];
                if (targetQ && (targetQ.s > 0 || targetQ.m > 0 || targetQ.l > 0)) {
                    isSelected = true;
                }
            } else if (row.type === 'item_toggle' || row.type === 'multiplier_input') {
                if (quantities[row.id] && quantities[row.id].checked) {
                    isSelected = true;
                }
            }

            if (isSelected && row.desc) {
                hasItems = true;
                printScopeList.innerHTML += `
                    <div class="print-scope-item">
                        <h4>• ${row.item}</h4>
                        <p>${row.desc}</p>
                    </div>
                `;
            }
        });

        if (!hasItems) {
            printScopeList.innerHTML = `<p style="color: #666; font-style: italic; width: 100%; font-size: 12px;">No specific installation services selected.</p>`;
        }
    }

    // Extended delay to guarantee iPad draws the DOM before printing
    window.triggerPrint = function() {
        preparePrint();
        setTimeout(function() {
            window.print();
        }, 250); 
    }
    
    // Math & Interactions
    window.adjustQty = function(id, size, delta) {
        let currentVal = parseInt(quantities[id][size]) || 0;
        let newVal = Math.max(0, currentVal + delta); 
        quantities[id][size] = newVal;
        document.getElementById(`input-${id}-${size}`).value = newVal;
        calculateTotals();
    }

    window.updateQty = function(id, size, val) {
        let newVal = Math.max(0, parseInt(val) || 0);
        quantities[id][size] = newVal;
        document.getElementById(`input-${id}-${size}`).value = newVal;
        calculateTotals();
    }

    window.updateToggle = function(id, isChecked) {
        quantities[id].checked = isChecked;
        calculateTotals();
    }

    window.updateMultiplier = function(id, val) {
        quantities[id].percent = parseFloat(val) || 0;
        calculateTotals();
    }

    window.resetCalculator = function() {
        if(confirm("Are you sure you want to clear all fields and start a new quote?")) {
            init(); 
            document.getElementById('custName').value = '';
            document.getElementById('custAddress').value = '';
            const todayReset = new Date();
            document.getElementById('quoteDate').value = todayReset.getFullYear() + '-' + String(todayReset.getMonth() + 1).padStart(2, '0') + '-' + String(todayReset.getDate()).padStart(2, '0');
            window.scrollTo(0, 0); 
        }
    }

    function calculateTotals() {
        let grandTotal = 0;
        let rowTotals = {}; 

        // Pass 1
        pricingData.forEach(row => {
            if (row.type === 'standard') {
                const q = quantities[row.id];
                const totalS = q.s * row.pS;
                const totalM = q.m * row.pM;
                const totalL = q.l * row.pL;
                rowTotals[row.id] = totalS + totalM + totalL;

                document.getElementById(`calc-${row.id}-s`).innerText = '$' + formatMoney(totalS);
                document.getElementById(`calc-${row.id}-m`).innerText = '$' + formatMoney(totalM);
                document.getElementById(`calc-${row.id}-l`).innerText = '$' + formatMoney(totalL);
            }
        });

        // Pass 2
        pricingData.forEach(row => {
            if (row.type === 'item_toggle') {
                if (quantities[row.id].checked) {
                    const targetQ = quantities[row.dependsOn];
                    rowTotals[row.id] = (targetQ.s * row.pS) + (targetQ.m * row.pM) + (targetQ.l * row.pL);
                } else {
                    rowTotals[row.id] = 0;
                }
            } else if (row.type === 'auto_item') {
                const targetQ = quantities[row.dependsOn];
                rowTotals[row.id] = (targetQ.s * row.pS) + (targetQ.m * row.pM) + (targetQ.l * row.pL);
            }
        });

        // Pass 3: Multipliers with dynamic inputs
        pricingData.forEach(row => {
            if (row.type === 'multiplier_input') {
                if (quantities[row.id].checked) {
                    let rangeSum = 0;
                    row.range.forEach(rangeId => {
                        rangeSum += (rowTotals[rangeId] || 0);
                    });
                    rowTotals[row.id] = rangeSum * (quantities[row.id].percent / 100);
                } else {
                    rowTotals[row.id] = 0;
                }
            }
        });

        // Final Pass
        pricingData.forEach(row => {
            const finalValue = rowTotals[row.id] || 0;
            if (!row.hidden) {
                document.getElementById(`total-${row.id}`).innerText = '$' + formatMoney(finalValue);
            }
            grandTotal += finalValue;
        });

        let combinedCaulkTotal = (rowTotals[6] || 0) + (rowTotals[7] || 0);
        document.getElementById('caulkTotalSummary').innerText = '$' + formatMoney(combinedCaulkTotal);

        document.getElementById('grandTotal').innerText = '$' + formatMoney(grandTotal);
    }

    window.onload = init;
</script>

</body>
</html>
